<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>yolov3模型转换 | Hexo</title>
    
    
        <meta property="og:site_name" content="Hexo">
    
    
        <meta property="article:author" content="John Doe">
    
    
        <link rel="icon" href="/img/favicon.ico">
    
    
<link rel="stylesheet" href="/css/minireset.min.css">

    
<link rel="stylesheet" href="/css/all.min.css">

    
<link rel="stylesheet" href="/css/csshake.min.css">

    
<link rel="stylesheet" href="/css/hljs/lioshi.css">

    
<link rel="stylesheet" href="/css/jquery.fancybox.min.css">

    
<link rel="stylesheet" href="/styl/main.css">

    
<script src="/js/jquery.min.js"></script>

    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/jquery.fancybox.min.js"></script>

    
<script src="/js/clipboard.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>
<body>
    <header>
  <div class="outer">
    <div class="inner">
      <h1 class="logo-wrap">
        <a>Hexo<b><sup>1.1</sup></b></a>
      </h1>
    </div>
    <div class="inner">
      <nav class="main-nav">
        
          <a href="/">首页</a>
        
          <a href="/archives">归档</a>
        
          <a href="/categories">分类</a>
        
          <a href="/tags">标签</a>
        
          <a href="/friends">友链</a>
        
          <a href="/about">关于</a>
        
          <a target="_blank" rel="noopener" href="https://www.baidu.com">百度</a>
        
      </nav>
    </div>
  </div>
</header>
    <div class="content">
        <section class="outer">
    <article>
        <div class="article-title">
    <h2>
        <a href="/2021/03/30/LinuxRelease/KhadasVim3/vim3/HowToTransformYolo/" class="shake shake-little" title="yolov3模型转换">
            
            yolov3模型转换
        </a>
    </h2>
    <div class="meta_box">
    
        
        
            
                
        
        <div class="meta meta_auth">
            <img src="/img/default.png" alt="head" />
            <p>anonymous</p>
        </div>
    
        
        
        <div class="meta meta_date">
            <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
            <p>发布于：2021年03月30日</p>
        </div>
    
        <div class="meta meta_update">
            <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
            <p>更新于：2021年03月30日</p>
        </div>
    </div>
    

</div>

        <hr>
        <div class="article-entry">
            
            
            
            <p>训练完成的模型是基于相应的框架运行的，尽管大部分框架都有c/c++接口，但是即使使用这些接口，仍然只能使用CPU或者GPU，想要使用NPU加速，就需要通过DDK将训练好的模型转换为使用NPU加速的模型代码。这篇文档主要介绍如何在SDK上适配我们的模型。<br><strong>说明</strong>: 下面的例子都是以训练好的khadas的物体检测模型为例。</p>
<h2 id="申请SDK"><a href="#申请SDK" class="headerlink" title="申请SDK"></a>申请SDK</h2><p>可以在我们<a target="_blank" rel="noopener" href="https://www.khadas.com/npu-toolkit-vim3">网站</a>上申请转换工具的SDK，填写相关的信息后，会通过邮件的方式发送SDK。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> acuity-toolkit-binary-5.0.0/conversion_scripts/</span><br></pre></td></tr></table></figure>

<h2 id="转换工具使用"><a href="#转换工具使用" class="headerlink" title="转换工具使用"></a>转换工具使用</h2><h3 id="0-import-model-sh"><a href="#0-import-model-sh" class="headerlink" title="0_import_model.sh"></a>0_import_model.sh</h3><p>参数设置</p>
<blockquote>
<ol>
<li><code>NAME</code> 设置为yolovX</li>
<li><code>--net-input</code> yolovX-voc.cfg文件位置</li>
<li><code>--weight-input</code> weights文件位置<br>例如:<br><code>NAME=yolov3</code><br><code>--net-input /home/khadas/Pictures/VOCdevkit/yolov3-train/yolov3-voc.cfg \</code><br><code>--weight-input /home/khadas/Pictures/VOCdevkit/yolov3-train/backup/yolov3-voc_final.weights \</code></li>
</ol>
</blockquote>
<h3 id="1-quantize-model-sh"><a href="#1-quantize-model-sh" class="headerlink" title="1_quantize_model.sh"></a>1_quantize_model.sh</h3><p>参数设置</p>
<blockquote>
<ol>
<li><code>NAME</code> 设置为yolovX</li>
<li><code>--source-file</code> 检验文件</li>
<li><code>--channel-mean-value</code> 设置成<code>0 0 0 256</code></li>
<li><code>--quantized-dtype</code> 设置成<code>dynamic_fixed_point-8</code></li>
</ol>
</blockquote>
<p>例如：</p>
<blockquote>
<p><code>NAME=yolov3</code><br><code>--channel-mean-value &#39;0 0 0 256&#39; \</code><br><code>--quantized-dtype dynamic_fixed_point-8 \</code></p>
</blockquote>
<h3 id="2-export-case-code-sh"><a href="#2-export-case-code-sh" class="headerlink" title="2_export_case_code.sh"></a>2_export_case_code.sh</h3><p>参数设置</p>
<blockquote>
<ol>
<li><code>NAME</code> 设置为yolovX</li>
<li><code>--reorder-channel</code> RGB的颜色通道顺序修改为BGR<code>2 1 0</code></li>
<li><code>--channel-mean-value</code> 设置为<code>0 0 0 256</code></li>
<li><code>--export-dtype</code> 设置为<code>quantized</code></li>
</ol>
</blockquote>
<p>例如:</p>
<blockquote>
<p><code>NAME=yolov3</code><br><code>--reorder-channel &#39;2 1 0&#39; \</code><br><code>--channel-mean-value &#39;0 0 0 256&#39; \</code><br><code>--export-dtype quantized \</code></p>
</blockquote>
<h3 id="运行转换工具"><a href="#运行转换工具" class="headerlink" title="运行转换工具"></a>运行转换工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cd acuity-toolkit-binary-5.0.0&#x2F;conversion_scripts&#x2F;</span><br><span class="line">$ chmod +x 0_import_model.sh</span><br><span class="line">$ chmod +x 1_quantize_model.sh</span><br><span class="line">$ chmod +x 2_export_case_code.sh</span><br><span class="line">$ .&#x2F;0_import_model.sh</span><br><span class="line">$ .&#x2F;1_quantize_model.sh</span><br><span class="line">$ .&#x2F;2_export_case_code.sh</span><br></pre></td></tr></table></figure>
<p>转换完成以后，在<code>acuity-toolkit-binary-5.0.0/conversion_scripts/</code>目录下，会生成一个与脚本中的名字相同的文件,这些文件就是转换完的基础文件。</p>
<h2 id="应用自己转换的代码"><a href="#应用自己转换的代码" class="headerlink" title="应用自己转换的代码"></a>应用自己转换的代码</h2><h3 id="下载aml-npu-app-以及-aml-npu-demo-binaries"><a href="#下载aml-npu-app-以及-aml-npu-demo-binaries" class="headerlink" title="下载aml_npu_app 以及 aml_npu_demo_binaries"></a>下载aml_npu_app 以及 aml_npu_demo_binaries</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd $workspace</span><br><span class="line">$ git clone https:&#x2F;&#x2F;gitlab.com&#x2F;khadas&#x2F;aml_npu_demo_binaries.git</span><br><span class="line">$ git clone https:&#x2F;&#x2F;gitlab.com&#x2F;khadas&#x2F;aml_npu_app.git</span><br></pre></td></tr></table></figure>
<p>下载完成以后会有两个目录<code>aml_npu_app</code>和<code>aml_npu_binaries</code></p>
<blockquote>
<ol>
<li>aml_npu_app里面的代码是生成可执行文件的源码</li>
<li>aml_npu_binaries里面的是可以直接执行的demo</li>
</ol>
</blockquote>
<h3 id="文件替换"><a href="#文件替换" class="headerlink" title="文件替换"></a>文件替换</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$workspace</span>/aml_npu_app/DDK_6.3.3.4/detect_library/model_code/detect_yolo_v3/</span><br></pre></td></tr></table></figure>

<ol>
<li>将转换工具转换出来的<code>yolov3.nb</code>文件复制过来，替换<code>nn_data</code>目录下的<code>yolov3_88.nb</code>.</li>
<li>将转换工具转换出来的<code>vnn_yolov3.c</code> 替换DDK目录下的<code>vnn_yolov3.c</code>。</li>
<li>将转换工具转换出来的<code>vnn_yolov3.h</code> 文件复制过来，替换<code>include</code>下的<code>vnn_yolov3.h</code>文件</li>
</ol>
<h3 id="文件修改"><a href="#文件修改" class="headerlink" title="文件修改"></a>文件修改</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd workspace&#x2F;aml_npu_app&#x2F;DDK_6.3.3.4&#x2F;detect_library&#x2F;model_code&#x2F;detect_yolo_v3&#x2F;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim yolovX_process.c</span><br></pre></td></tr></table></figure>
<p>修改3个位置</p>
<ol>
<li><code>*coco_names[]</code> 的内容修改为你训练的模型的class，顺序要和你训练时的.names文件一致。</li>
<li><code>num_class</code>  的值修改为你训练的class的大小</li>
<li><code>size[3]</code> 的最后一个参数修改为<code>(num_class+5)*3</code></li>
</ol>
<p>例如:</p>
<blockquote>
<ol>
<li><code>*coco_names[] = [&quot;person&quot;, &quot;bicycle&quot;, &quot;car&quot;, &quot;motorbike&quot;, &quot;aeroplane&quot;, &quot;bus&quot;, &quot;train&quot;, &quot;truck&quot;, &quot;boat&quot;, &quot;traffic light&quot;, &quot;fire hydrant&quot;, &quot;stop sign&quot;, &quot;parking meter&quot;, &quot;bench&quot;, &quot;bird&quot;, &quot;cat&quot;, &quot;dog&quot;, &quot;horse&quot;, &quot;sheep&quot;, &quot;cow&quot;, &quot;elephant&quot;, &quot;bear&quot;, &quot;zebra&quot;, &quot;giraffe&quot;, &quot;backpack&quot;, &quot;umbrella&quot;, &quot;handbag&quot;, &quot;tie&quot;, &quot;suitcase&quot;, &quot;frisbee&quot;, &quot;skis&quot;, &quot;snowboard&quot;, &quot;sports ball&quot;, &quot;kite&quot;, &quot;baseball bat&quot;, &quot;baseball glove&quot;, &quot;skateboard&quot;, &quot;surfboard&quot;, &quot;tennis racket&quot;, &quot;bottle&quot;, &quot;wine glass&quot;, &quot;cup&quot;, &quot;fork&quot;, &quot;knife&quot;, &quot;spoon&quot;, &quot;bowl&quot;, &quot;banana&quot;, &quot;apple&quot;, &quot;sandwich&quot;, &quot;orange&quot;, &quot;broccoli&quot;, &quot;carrot&quot;, &quot;hot dog&quot;, &quot;pizza&quot;, &quot;donut&quot;, &quot;cake&quot;, &quot;chair&quot;, &quot;sofa&quot;, &quot;pottedplant&quot;, &quot;bed&quot;, &quot;diningtable&quot;, &quot;toilet&quot;, &quot;tvmonitor&quot;, &quot;laptop&quot;, &quot;mouse&quot;, &quot;remote&quot;, &quot;keyboard&quot;, &quot;cell phone&quot;, &quot;microwave&quot;, &quot;oven&quot;, &quot;toaster&quot;, &quot;sink&quot;, &quot;refrigerator&quot;, &quot;book&quot;, &quot;clock&quot;, &quot;vase&quot;, &quot;scissors&quot;, &quot;teddy bear&quot;, &quot;hair drier&quot;, &quot;toothbrush&quot;, &quot;Edge-V&quot;, &quot;Edge&quot;, &quot;VIM1&quot;, &quot;VIM2&quot;, &quot;VIM3&quot;, &quot;VIM3L&quot;, &quot;Fan3705&quot;, &quot;Captain&quot;, &quot;Captain+Edge&quot;, &quot;ToneBoard&quot;, &quot;Heatsink(VIMs)&quot;, &quot;Heatsink(Edge)];</code></li>
<li><code>num_class=92</code></li>
<li><code>int size[3]=&#123;nn_width/32, nn_height/32,97*3&#125;;</code></li>
</ol>
</blockquote>
<h3 id="代码编译"><a href="#代码编译" class="headerlink" title="代码编译"></a>代码编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> workspace/aml_npu_app/DDK_6.3.3.4/detect_library/model_code/detect_yolo_v3/</span><br><span class="line">$ ./build_vx.sh <span class="variable">$path</span>/to/linux_sdk_dir <span class="variable">$path</span>/to/fenix</span><br></pre></td></tr></table></figure>
<p>编译相应的yolov3目录以后，在<code>bin_r</code>目录下会找到生成的<code>.so</code>文件。</p>
<h3 id="替换demo文件"><a href="#替换demo文件" class="headerlink" title="替换demo文件"></a>替换demo文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$workspace</span>/aml_npu_demo_binaries/detect_demo/</span><br></pre></td></tr></table></figure>
<p>替换两个位置</p>
<ol>
<li>复制上一步生成的so文替换到lib里</li>
<li>复制上一步的nb文件替换nn_data里面的文件<br>举例：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp workspace&#x2F;aml_npu_app&#x2F;DDK_6.3.3.4&#x2F;detect_library&#x2F;model_code&#x2F;detect_yolo_v3&#x2F;bin_dir&#x2F;libnn_yolo_v3.so $workspace&#x2F;aml_npu_demo_binaries&#x2F;detect_demo&#x2F;lib&#x2F;libnn_yolo_v3.so</span><br><span class="line">$ cp workspace&#x2F;aml_npu_app&#x2F;DDK_6.3.3.4&#x2F;detect_library&#x2F;model_code&#x2F;detect_yolo_v3&#x2F;nn_data&#x2F;yolov3_88.nb $workspace&#x2F;aml_npu_demo_binaries&#x2F;detect_demo&#x2F;n_data&#x2F;yolov3_88.nb</span><br></pre></td></tr></table></figure></li>
</ol>
<p>完成之后的demo就可以运行你自己的模型了.</p>

        </div>
        <div class="article-copyright">
            
    <blockquote>
        <p>
            
        </p>
    </blockquote>


        </div>
    </article>
    

    <section id="toc-div" >
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7SDK"><span class="toc-text">申请SDK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="toc-text">转换工具使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-import-model-sh"><span class="toc-text">0_import_model.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-quantize-model-sh"><span class="toc-text">1_quantize_model.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-export-case-code-sh"><span class="toc-text">2_export_case_code.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7"><span class="toc-text">运行转换工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%87%AA%E5%B7%B1%E8%BD%AC%E6%8D%A2%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">应用自己转换的代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDaml-npu-app-%E4%BB%A5%E5%8F%8A-aml-npu-demo-binaries"><span class="toc-text">下载aml_npu_app 以及 aml_npu_demo_binaries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9B%BF%E6%8D%A2"><span class="toc-text">文件替换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="toc-text">文件修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91"><span class="toc-text">代码编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2demo%E6%96%87%E4%BB%B6"><span class="toc-text">替换demo文件</span></a></li></ol></li></ol>
    </section>
    <section id="gohome" style="display: none;"><a>顶</a></section>

    <script>
        function get_top_by_link(link){
            var hnid = "#" + $(link).attr("data");
            if ($(hnid).length > 0){
                return $(hnid).offset().top;
            }else{
                return 0;
            }
        }
        //go to hn
        function gotohn(link){
            $("html,body").animate({scrollTop: get_top_by_link(link) }, 300);
        }
        //页面滚动
        function update(){
            var scrollH = $(window).scrollTop();
            if($(".toc-link")){
                $(".toc-link").each(function(i,link){
                    var mdHeight = get_top_by_link(link);
                    if(mdHeight <= scrollH + 40){
                        //高亮导航菜单
                        $('.toc-link').removeClass('on');
                        $(link).addClass('on');
                    }
                });
            }
            //返回顶部显隐
            if(scrollH < 200){
                $("#gohome").css("display","none");
            }else{
                $("#gohome").css("display","block");
            }
        }
        $(function(){
            //修复部分锚点从属关系
            if($("#toc-div >li").length > 0){
                $("#toc-div >li").appendTo($("#toc-div >ol:first"));
            }
            //返回顶部
            $('#gohome').click(function(){
                $("html,body").animate({scrollTop: 0}, 300);
                return false;
            })
            //遍历锚点
            $(".toc-link").each(function(i,link){
                $(link).attr("data",$(link).attr('href').substring(1));
                $(link).attr("href","javascript:void(0);");
                $(link).attr("onclick","gotohn(this);");
            })
            //绑定滚动事件
            $(window).bind('scroll', update);
            //初始化toc
            var first_toc = $(".toc-link")[0];
            var first_scroll = get_top_by_link(first_toc);
            var window_scroll = $(window).scrollTop();
            if(window_scroll <= first_scroll){
                $(first_toc).addClass('on');
            }
        })
    </script>

</section>
    </div>
    <footer>
    <div class="outer">
        <div class="inner">
            Powered by <a href="http://prowiki.demopage.icu/" target="_blank">ProWiki</a>
            &copy;2021 BW<br>
            <a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">皖ICP备00000000号</a>
        </div>
    </div>
</footer>

<script src="/js/custom.js"></script>


    <script>onload_content();</script>

</body>
</html>
